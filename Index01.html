<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>B3運費計算機</title>
<style>
  body {font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; padding: 20px;}
  label {display:block; margin-top:10px;}
  input[type="number"], input[type="text"] {width:100%; padding:8px;}
  button {margin-top:20px; padding:10px 20px;}
  #result {margin-top:20px; background:#f2f2f2; padding:15px; border-radius:8px;}
</style>
</head>
<body>
<h2>B3運費計算機</h2>
<label>長(公分): <input type="number" id="lengthCm" step="0.1"></label>
<label>寬(公分): <input type="number" id="widthCm" step="0.1"></label>
<label>高(公分): <input type="number" id="heightCm" step="0.1"></label>
<label>重量(公斤): <input type="number" id="weightKg" step="0.1"></label>
<label>美國Zipcode: <input type="text" id="zipcode"></label>
<button onclick="calc()">計算運費</button>

<div id="result"></div>

<script>
const webAppUrl = "https://script.google.com/macros/s/AKfycbzQ1JKjW-Ki42R8cXFJ7oz10sjcUYu1PBRPfjQPeP-w_0tHEWDOCZr1x_tkbBje56jgrA/exec";

function ceil(val){ return Math.ceil(val); }

function calc(){
  const lenCm = parseFloat(document.getElementById('lengthCm').value)||0;
  const widCm = parseFloat(document.getElementById('widthCm').value)||0;
  const heiCm = parseFloat(document.getElementById('heightCm').value)||0;
  const wKg   = parseFloat(document.getElementById('weightKg').value)||0;
  const zip   = document.getElementById('zipcode').value.trim();

  // 單位轉換
  const lenIn = ceil(lenCm / 2.54);
  const widIn = ceil(widCm / 2.54);
  const heiIn = ceil(heiCm / 2.54);
  const wLb   = ceil(wKg / 0.454);

  // 材積重
  const dimWeight = ceil((lenIn * widIn * heiIn) / 139);
  const billableWeight = Math.max(dimWeight, wLb);

  const intlCost = billableWeight * 3.99;
  const serviceFee = billableWeight <= 20 ? 6 : 0;

  // 先顯示國際部分
  let html = `
    實際重量: ${wLb} 磅<br>
    材積重: ${dimWeight} 磅<br>
    計費重量: ${billableWeight} 磅<br>
    國際運費: $${intlCost.toFixed(2)}<br>
    服務費(≤20磅): $${serviceFee}
    <hr>
    查詢美國國內運費中...
  `;
  document.getElementById('result').innerHTML = html;

  // 取得美國國內運費
  fetch(`${webAppUrl}?zip=${zip}&weight=${billableWeight}`)
    .then(r=>r.json())
    .then(data=>{
      if(data.error){
        document.getElementById('result').innerHTML += `<br>國內運費錯誤: ${data.error}`;
      }else{
        const total = intlCost + serviceFee + parseFloat(data.rate);
        document.getElementById('result').innerHTML += `
          分區: ${data.zone}<br>
          美國國內運費: $${data.rate}<br>
          <b>總運費: $${total.toFixed(2)}</b>
        `;
      }
    })
    .catch(err=>{
      document.getElementById('result').innerHTML += `<br>取得國內運費失敗: ${err}`;
    });
}
</script>
</body>
</html>

