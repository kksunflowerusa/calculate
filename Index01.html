<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>B4運費計算器</title>
<style>
  body {font-family: Arial, sans-serif; max-width: 900px; margin: 30px auto; padding: 20px;}
  label {display:block; margin-top:10px;}
  input[type="number"] {margin-top:5px; padding:6px; width:100%;}
  select, button {margin-top:15px; padding:8px 15px;}
  #itemsContainer {margin-top:20px;}
  .item-block {border:1px solid #ccc; padding:12px; margin-top:15px; background:#f9f9f9;}
  #output {margin-top:25px; padding:12px; border:1px solid #ccc; background:#f0f0f0;}
</style>
</head>
<body>
  <h2>B4運費計算器</h2>

  <label>件數：
    <select id="packageCount" onchange="generateInputs()">
      <option value="1" selected>1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
  </label>

  <div id="itemsContainer"></div>

  <button onclick="calculate()">計算金額</button>

  <div id="output"></div>

<script>
function generateInputs() {
  const container = document.getElementById('itemsContainer');
  container.innerHTML = '';
  const count = parseInt(document.getElementById('packageCount').value, 10);

  for (let i = 1; i <= count; i++) {
    container.insertAdjacentHTML('beforeend', `
      <div class="item-block">
        <strong>第 ${i} 件</strong><br>
        <label>長 (公分)：<input type="number" step="0.01" id="length${i}"></label>
        <label>寬 (公分)：<input type="number" step="0.01" id="width${i}"></label>
        <label>高 (公分)：<input type="number" step="0.01" id="height${i}"></label>
        <label>重量 (公斤)：<input type="number" step="0.01" id="weight${i}"></label>
      </div>
    `);
  }
}

// 預設產生 1 件輸入
generateInputs();

function parseNumberLoose(v) {
  const s = String(v ?? '').replace(/[^\d.\-]/g, '');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : NaN;
}

function findRateInObj(obj) {
  if (!obj) return null;
  const keys = ['usdCashSell','usdSell','cashSell','sell','rate','exchangeRate','usd_to_twd'];
  for (const k of Object.keys(obj)) {
    if (keys.includes(k) && Number.isFinite(parseNumberLoose(obj[k]))) {
      const v = parseNumberLoose(obj[k]);
      if (v > 1 && v < 200) return v;
    }
  }
  if (obj.rates && obj.rates.TWD) {
    const v = parseNumberLoose(obj.rates.TWD);
    if (v > 1 && v < 200) return v;
  }
  return null;
}

async function getExchangeRate() {
  const url = 'https://script.google.com/macros/s/AKfycbynG8dx7ZcYkHdI6clpdlUelTgwwGjuEx6z98XX19ZCR__rEoScW_IxAmHFuC9Go7o9/exec';
  try {
    const res = await fetch(url, {cache: 'no-cache'});
    const json = await res.json();
    const rate = findRateInObj(json);
    if (rate) return Number(rate) + 0.8;
  } catch {}
  return null;
}

async function calculate() {
  const count = parseInt(document.getElementById('packageCount').value, 10);
  const today = new Date().toLocaleDateString();

  let totalLb = 0;
  let totalUsd = 0;
  const results = [];

  for (let i = 1; i <= count; i++) {
    const l = parseFloat(document.getElementById(`length${i}`).value) || 0;
    const w = parseFloat(document.getElementById(`width${i}`).value) || 0;
    const h = parseFloat(document.getElementById(`height${i}`).value) || 0;
    const kg = parseFloat(document.getElementById(`weight${i}`).value) || 0;

    const li = Math.ceil(l / 2.54);
    const wi = Math.ceil(w / 2.54);
    const hi = Math.ceil(h / 2.54);

    const volumetricLb = Math.ceil((li * wi * hi) / 139);
    const actualLb = Math.ceil(kg / 0.454);
    const chargeableLb = Math.max(volumetricLb, actualLb);

    const usd = 30 + 3.99 * Math.max(0, chargeableLb - 1);

    totalLb += chargeableLb;
    totalUsd += usd;

    results.push({
      index: i,
      li, wi, hi,
      volumetricLb, actualLb, chargeableLb,
      usd: usd.toFixed(2)
    });
  }

  const rate = await getExchangeRate();
  const rateText = rate ? rate.toFixed(3) : 'N/A';
  const totalTwd = rate ? Math.ceil(totalUsd * rate) : 'N/A';

  let html = results.map(r => `
    <strong>第 ${r.index} 件</strong><br>
    尺寸：${r.li} × ${r.wi} × ${r.hi} 英寸<br>
    材積重：${r.volumetricLb} 磅<br>
    實際重：${r.actualLb} 磅<br>
    計費重量：${r.chargeableLb} 磅<br>
    應付金額：$${r.usd} 美元<br><br>
  `).join('');

  html += `<hr>
    <strong>總計</strong><br>
    總計費重量：${totalLb} 磅<br>
    應付總金額：$${totalUsd.toFixed(2)} 美元<br>
    台幣總金額：約 NT$${totalTwd}<br>
    使用匯率：1 USD = NT$${rateText}<br>
    今日日期：${today}
  `;

  document.getElementById('output').innerHTML = html;
}
</script>
</body>
</html>

