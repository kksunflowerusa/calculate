<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>網頁版運費計算機</title>
<style>
body { font-family: Arial, Helvetica, sans-serif; max-width:760px; margin:30px auto; padding:10px; }
label { display:block; margin-top:10px; }
input[type="number"], input[type="text"] { width:160px; padding:6px; }
button { margin-top:12px; padding:8px 14px; }
.result { margin-top:16px; padding:12px; border:1px solid #ddd; background:#fafafa; }
.error { color: #b00; }
</style>
</head>
<body>
<h2>網頁版運費計算機</h2>

<form id="calcForm">
  <label>長（公分） <input id="length" type="number" step="0.01" required /></label>
  <label>寬（公分） <input id="width" type="number" step="0.01" required /></label>
  <label>高（公分） <input id="height" type="number" step="0.01" required /></label>
  <label>重量（公斤） <input id="weight" type="number" step="0.01" required /></label>
  <label>收件 Zip code（美國） <input id="zip" type="text" required /></label>
  <button type="submit">計算運費</button>
</form>

<div id="msg" class="error"></div>
<div id="out" class="result" style="display:none;"></div>

<script>
// 前端 Zip code -> 分區
function findZone(zipStr){
  if (!zipStr) return null;
  const digits = zipStr.replace(/\D/g,'');
  if (!digits) return null;
  const zip = parseInt(digits,10);
  if (isNaN(zip)) return null;

  const zoneRanges = {
    'A1': [ [96701,96898] ],
    'B2': [ [96910,96970],[600,999],[99501,99950] ],
    'C3': [ [1001,5544],[2801,2940],[3031,3897],[3901,4992],[5001,5907],[6001,6928],[7001,8989],[98001,99403],[97001,97920] ],
    'D4': [ [90001,96162],[80001,81658],[82001,83877],[84001,84791],[88901,89883],[55001,56763],[57001,57799],[58001,58856],[59001,59937] ],
    'E5': [ [10001,14925],[15001,19640],[19701,19980] ],
    'F6': [ [50001,52809],[53001,54990],[20001,20091],[20101,24658],[20588,21930],[24701,26886],[43001,45999],[46001,47997],[48001,49971] ],
    'G7': [ [27006,28909],[29001,29945],[85001,86556],[87001,88439],[63001,65899],[68001,69367],[60001,62999],[66002,67954],[32003,34997],[30002,39901],[40003,42788] ],
    'H8': [ [70001,71497],[71601,72959],[73001,74966],[75001,79999],[88510,88590],[35004,36925],[37010,38589],[38601,39776] ]
  };

  for (const zone in zoneRanges) {
    const ranges = zoneRanges[zone];
    for (let i=0;i<ranges.length;i++){
      const s = ranges[i][0], e = ranges[i][1];
      if (zip >= s && zip <= e) return zone;
    }
  }
  return null;
}

// 表單提交事件
document.getElementById('calcForm').addEventListener('submit', async function(e){
  e.preventDefault();
  document.getElementById('msg').textContent = '';
  document.getElementById('out').style.display = 'none';

  const length = parseFloat(document.getElementById('length').value);
  const width  = parseFloat(document.getElementById('width').value);
  const height = parseFloat(document.getElementById('height').value);
  const weight = parseFloat(document.getElementById('weight').value);
  const zip    = document.getElementById('zip').value.trim();

  if (!length || !width || !height || !weight || !zip) {
    document.getElementById('msg').textContent = '請輸入所有欄位';
    return;
  }

  // 計算材積重與實重（磅）
  function cmToInchesCeil(cm){ return Math.ceil(cm / 2.54); }
  const L_in = cmToInchesCeil(length);
  const W_in = cmToInchesCeil(width);
  const H_in = cmToInchesCeil(height);
  const volumetric_raw = (L_in * W_in * H_in) / 139;
  const volumetric_w = Math.ceil(volumetric_raw);
  const actual_w = Math.ceil(weight / 0.454);
  const billingWeight = Math.max(volumetric_w, actual_w);

  // 前端先判斷分區
  const zone = findZone(zip);
  if (!zone) {
    document.getElementById('msg').textContent = '無法判斷該 Zip code 的分區';
    return;
  }

  let html = `<strong>分區：</strong>${zone}<br/>
              <strong>計費重量：</strong>${billingWeight} 磅（材積:${volumetric_w} / 實重:${actual_w}）<br/>`;

  // 超過 100 磅 → 提示聯繫客服
  if (billingWeight > 100) {
    html += '<strong style="color:red">計費重量超過 100 磅，請聯繫客服報價</strong>';
    document.getElementById('out').innerHTML = html;
    document.getElementById('out').style.display = 'block';
    return;
  }

  // 前端計算國際運費與服務費
  const internationalRate = billingWeight * 3.99;
  const serviceFee = (billingWeight <= 20) ? 6.00 : 0.00;
  html += `<strong>國際運費：</strong>$${internationalRate.toFixed(2)}<br/>
           <strong>服務費：</strong>$${serviceFee.toFixed(2)}<br/>`;

  // 呼叫 Apps Script 查分區 + 磅數對應的美國國內運費
  const GAS_URL = 'https://script.google.com/macros/s/AKfycbwEFMmo7MoFC8Xw_Z5DIfnnKd-2S18H1R0ySAVM8kG7_q_X4yGXViwBcCnba79TlOONsw/exec';
  const url = GAS_URL + `?zone=${zone}&billingWeight=${billingWeight}`;

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) {
      document.getElementById('msg').textContent = '錯誤：' + (data.message || data.error);
      return;
    }

    const domesticRate = data.domesticRate;
    const total = internationalRate + serviceFee + domesticRate;

    html += `<strong>美國國內運費：</strong>$${domesticRate.toFixed(2)}<br/>
             <hr/><strong>總計：</strong>$${total.toFixed(2)}`;

    document.getElementById('out').innerHTML = html;
    document.getElementById('out').style.display = 'block';

  } catch(err) {
    document.getElementById('msg').textContent = '發生錯誤（網路或後端）';
    console.error(err);
  }

});
</script>
</body>
</html>

