<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>B4運費計算器</title>
<style>
  body {font-family: Arial, sans-serif; max-width: 800px; margin: 30px auto; padding: 20px;}
  label {display:block; margin-top:10px;}
  input[type="number"] {margin-top:5px; padding:6px; width:100%;}
  button {margin-top:15px; padding:8px 15px;}
  #packages {margin-top:20px;}
  .pkg-block {border:1px solid #ccc; padding:15px; margin-top:15px; background:#f9f9f9;}
  #output {margin-top:20px; padding:12px; border:1px solid #ccc; background:#f9f9f9;}
  .small {font-size:0.9rem; color:#555;}
  .inline {display:flex; gap:10px; align-items:center;}
  .inline input {flex:1;}
</style>
</head>
<body>
<h2>B4運費計算器</h2>

<label>件數：
  <input type="number" id="packageCount" value="1" min="1" step="1" onchange="renderPackageInputs()">
</label>

<div id="packages"></div>
<button onclick="calculate()">計算金額</button>
<div id="output"></div>

<script>
// 解析數字（可處理含逗號與貨幣符號）
function parseNumberLoose(v) {
  if (v == null) return NaN;
  if (typeof v === 'number') return v;
  const s = String(v).replace(/[^\d.\-]/g, '');
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : NaN;
}

// 嘗試找出合理匯率
function findRateInObj(obj) {
  if (obj == null) return null;
  const keys = ['usdCashSell','usdSell','cashSell','sell','rate','exchangeRate','usd_to_twd','usdtotwd','usdToTwd','USDTWD','TWD','twd'];
  for (const k of Object.keys(obj)) {
    for (const c of keys) {
      if (k.toLowerCase() === c.toLowerCase()) {
        const v = parseNumberLoose(obj[k]);
        if (Number.isFinite(v) && v > 1 && v < 200) return v;
      }
    }
  }
  if (obj.rates && obj.rates.TWD) {
    const v = parseNumberLoose(obj.rates.TWD);
    if (Number.isFinite(v) && v > 1 && v < 200) return v;
  }
  function recur(o, depth=0) {
    if (depth > 6 || o == null) return null;
    if (typeof o === 'number' && o > 1 && o < 200) return o;
    if (typeof o === 'string') {
      const n = parseNumberLoose(o);
      if (Number.isFinite(n) && n > 1 && n < 200) return n;
    }
    if (Array.isArray(o)) {
      for (const el of o) {
        const r = recur(el, depth+1);
        if (r) return r;
      }
    } else if (typeof o === 'object') {
      for (const k of Object.keys(o)) {
        const r = recur(o[k], depth+1);
        if (r) return r;
      }
    }
    return null;
  }
  return recur(obj,0);
}

// 動態生成輸入欄位
function renderPackageInputs() {
  const count = parseInt(document.getElementById('packageCount').value) || 1;
  const container = document.getElementById('packages');
  container.innerHTML = '';
  for (let i=1; i<=count; i++) {
    container.innerHTML += `
      <div class="pkg-block">
        <strong>第 ${i} 件</strong>
        <label>長 (公分)：<input type="number" id="length${i}" step="0.01"></label>
        <label>寬 (公分)：<input type="number" id="width${i}" step="0.01"></label>
        <label>高 (公分)：<input type="number" id="height${i}" step="0.01"></label>
        <label>重量 (公斤)：<input type="number" id="weight${i}" step="0.01"></label>
        <label>折扣 (%)：
          <div class="inline">
            <input type="number" id="discount${i}" value="100" step="1" min="1">
            <button type="button" onclick="applyDiscountAll(${i})">全部套用折扣</button>
          </div>
        </label>
      </div>`;
  }
}
renderPackageInputs(); // 初始 1 件

// 全部套用折扣
function applyDiscountAll(idx) {
  const val = document.getElementById(`discount${idx}`).value;
  const count = parseInt(document.getElementById('packageCount').value) || 1;
  for (let i=1; i<=count; i++) {
    document.getElementById(`discount${i}`).value = val;
  }
}

async function calculate() {
  const pkgCount = parseInt(document.getElementById('packageCount').value) || 1;
  const url = 'https://script.google.com/macros/s/AKfycbx6jRRXCt3xgWVQBulc945UAe6nS1HtaxDVcvxixzYbNdDT7iY_nir4EzvRyGRtXA/exec';
  let baseRate = null;

  try {
    const res = await fetch(url, { cache: 'no-cache' });
    try {
      const json = await res.json();
      baseRate = findRateInObj(json);
    } catch {
      const txt = await res.text();
      const m = txt.match(/([0-9]+(?:\.[0-9]+)?)/g);
      if (m) {
        for (const x of m) {
          const v = parseNumberLoose(x);
          if (Number.isFinite(v) && v > 1 && v < 200) { baseRate = v; break; }
        }
      }
    }
  } catch(e){ console.error('匯率抓取錯誤', e); }

  // 加上0.8並格式化到小數點三位
  const finalRate = baseRate ? (baseRate + 0.8) : null;
  const rateDisplay = finalRate ? finalRate.toFixed(3) : 'N/A';

  let outputHTML = '';
  let totalLb = 0;
  let totalUsd = 0;

  for (let i=1; i<=pkgCount; i++) {
    const lengthCm = parseFloat(document.getElementById(`length${i}`).value) || 0;
    const widthCm  = parseFloat(document.getElementById(`width${i}`).value)  || 0;
    const heightCm = parseFloat(document.getElementById(`height${i}`).value) || 0;
    const weightKg = parseFloat(document.getElementById(`weight${i}`).value) || 0;
    const discountPercent = parseFloat(document.getElementById(`discount${i}`).value) || 100;

    const lengthIn = Math.ceil(lengthCm / 2.54);
    const widthIn  = Math.ceil(widthCm / 2.54);
    const heightIn = Math.ceil(heightCm / 2.54);

    const volumetricLb = Math.ceil((lengthIn * widthIn * heightIn) / 139);
    const actualLb     = Math.ceil(weightKg / 0.454);
    const chargeableLb = Math.max(volumetricLb, actualLb);

    // 運費公式：首磅30 + 續磅4.69 * (chargeableLb - 1)
    const usdAmount = 30 + (chargeableLb > 1 ? (chargeableLb - 1) * 4.69 : 0);
    const usdDiscounted = usdAmount * (discountPercent / 100);

    totalLb += chargeableLb;
    totalUsd += usdDiscounted;

    const twdAmount = finalRate ? Math.ceil(usdDiscounted * finalRate) : 'N/A';

    outputHTML += `
      <div class="pkg-block">
        <strong>第 ${i} 件結果</strong><br>
        轉換後尺寸：${lengthIn} × ${widthIn} × ${heightIn} 英寸<br>
        材積重：${volumetricLb} 磅<br>
        實際重：${actualLb} 磅<br>
        計費重量：${chargeableLb} 磅<br>
        應付金額：$${usdAmount.toFixed(2)} 美元<br>
        折扣：${discountPercent}%<br>
        折扣後應付金額：$${usdDiscounted.toFixed(2)} 美元<br>
        台幣金額：約 NT$${twdAmount}
      </div>`;
  }

  const pickupFeeUsd = pkgCount * 5;
  const grandTotalUsd = totalUsd + pickupFeeUsd;
  const totalTwd = finalRate ? Math.ceil(grandTotalUsd * finalRate) : 'N/A';
  const today = new Date().toLocaleDateString('zh-TW', { year:'numeric', month:'2-digit', day:'2-digit' });

  outputHTML += `
    <div style="margin-top:20px; padding:15px; border-top:2px solid #000;">
      <strong>B4運費報價</strong><br>
      總計計費重量：${totalLb} 磅<br>
      取件費（${pkgCount} 件 × $5）：$${pickupFeeUsd.toFixed(2)} 美元<br>
      總計應付金額(含取件費)：$${grandTotalUsd.toFixed(2)} 美元<br>
      台幣總金額：約 NT$${totalTwd}<br>
      使用匯率：1 USD = NT$${rateDisplay}<br>
      今日日期：${today}
    </div>`;

  document.getElementById('output').innerHTML = outputHTML;
}
</script>
</body>
</html>
