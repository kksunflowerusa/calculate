<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>台灣→美國 運費計算機</title>
<style>
  body {font-family: Arial, sans-serif; max-width: 720px; margin: 30px auto; padding: 20px;}
  label {display:block; margin-top:12px;}
  input[type="number"], input[type="text"] {width:100%; padding:8px; box-sizing:border-box; margin-top:4px;}
  button {margin-top:16px; padding:10px 18px; font-size:16px; border-radius:8px;}
  #result {margin-top:20px; padding:15px; border:1px solid #ccc; background:#f9f9f9;}
  .error {color:#b00020;}
</style>
</head>
<body>
<h2>台灣→美國 運費計算機</h2>

<!-- 尺寸輸入 -->
<label>長 (公分)：<input type="number" id="length" step="0.01"></label>
<label>寬 (公分)：<input type="number" id="width"  step="0.01"></label>
<label>高 (公分)：<input type="number" id="height" step="0.01"></label>
<label>重量 (公斤)：<input type="number" id="weight" step="0.01"></label>

<!-- 美國收件資訊 -->
<label>美國收件 Zip code（5 位）：<input type="text" id="zip" maxlength="5"></label>

<button onclick="calcTotal()">計算總運費</button>

<div id="result"></div>

<script>
// === 1. 主要計算 ===
async function calcTotal(){
  const out = document.getElementById('result');
  out.className = '';
  out.innerHTML = '計算中…';

  const lenCm = parseFloat(document.getElementById('length').value)||0;
  const widCm = parseFloat(document.getElementById('width').value)||0;
  const heiCm = parseFloat(document.getElementById('height').value)||0;
  const kg    = parseFloat(document.getElementById('weight').value)||0;
  const zip   = document.getElementById('zip').value.trim();

  if(!zip || zip.length!==5 || !/^\d{5}$/.test(zip)){
    out.innerHTML = '<span class="error">請輸入正確的 5 位數 Zip code。</span>';
    return;
  }
  if(lenCm<=0||widCm<=0||heiCm<=0||kg<=0){
    out.innerHTML = '<span class="error">請輸入正確的尺寸與重量。</span>';
    return;
  }

  // === 2. 單位換算與材積重 ===
  const lIn = Math.ceil(lenCm/2.54);
  const wIn = Math.ceil(widCm/2.54);
  const hIn = Math.ceil(heiCm/2.54);
  const volumetricLb = Math.ceil((lIn * wIn * hIn) / 139);
  const actualLb = Math.ceil(kg / 0.454);
  const billableLb = Math.max(volumetricLb, actualLb);

  // === 3. 國際運費 (台灣→美國) ===
  let intlUsd = billableLb * 3.99;

  // === 4. TW服務費 ===
  const twService = (billableLb <= 20) ? 6 : 0;

  // === 5. 美國國內運費 (呼叫 Google Apps Script) ===
  const apiUrl = 'https://script.google.com/macros/s/AKfycbz8MZ8WBqekZF8JtaEthyFDmzz6KhxtzSFXM3L8nByU_wtQaQKkM3lXGiwu9jXMw8aOtw/exec'
               + `?zip=${encodeURIComponent(zip)}&weight=${billableLb}`;
  let usDomesticUsd = 0;
  try {
    const resp = await fetch(apiUrl);
    const data = await resp.json();
    if(data.success){
      usDomesticUsd = parseFloat(data.rate) || 0;
    }else{
      out.innerHTML = `<span class="error">查詢美國國內運費失敗：${data.message}</span>`;
      return;
    }
  } catch(err){
    out.innerHTML = `<span class="error">美國國內運費 API 發生錯誤：${err.message}</span>`;
    return;
  }

  const totalUsd = intlUsd + twService + usDomesticUsd;

  // === 6. 抓取匯率 (USD→TWD) ===
  let rate = null;
  try{
    const r = await fetch('https://open.er-api.com/v6/latest/USD');
    const j = await r.json();
    rate = j?.rates?.TWD ? parseFloat(j.rates.TWD) : null;
  }catch{}

  const rateDisplay = rate ? rate.toFixed(3) : 'N/A';
  const totalTwd = rate ? Math.ceil(totalUsd * rate) : 'N/A';
  const today = new Date().toLocaleDateString();

  // === 7. 結果輸出 ===
  out.innerHTML = `
    <strong>計算結果</strong><br>
    尺寸(英吋)：${lIn} × ${wIn} × ${hIn}<br>
    材積重：${volumetricLb} lb　實際重：${actualLb} lb<br>
    計費重量：<strong>${billableLb} lb</strong><br><hr>
    台灣→美國國際運費：$${intlUsd.toFixed(2)}<br>
    TW服務費(≤20lb +$6)：$${twService.toFixed(2)}<br>
    美國國內運費：$${usDomesticUsd.toFixed(2)}<br>
    <strong>總運費：$${totalUsd.toFixed(2)} USD</strong><br><hr>
    約合台幣：<strong>${ totalTwd==='N/A'?'N/A':('NT$'+totalTwd) }</strong><br>
    使用匯率：1 USD = NT$${rateDisplay}<br>
    今日日期：${today}
  `;
}
</script>
</body>
</html>
