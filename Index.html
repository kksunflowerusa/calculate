<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>運費計算機</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
      background: #f9f9f9;
    }
    h2 { color: #333; }
    form {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 400px;
    }
    label {
      display: block;
      margin-bottom: 10px;
    }
    input {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      margin-top: 12px;
      padding: 10px;
      width: 100%;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    #result {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .error { color: red; }
  </style>
</head>
<body>
  <h2>運費計算機</h2>
  <form id="shippingForm">
    <label>長 (cm): <input type="number" id="length" required></label>
    <label>寬 (cm): <input type="number" id="width" required></label>
    <label>高 (cm): <input type="number" id="height" required></label>
    <label>重量 (kg): <input type="number" id="weight" required></label>
    <label>收件 Zip code: <input type="text" id="zipcode" required></label>
    <button type="submit">計算運費</button>
  </form>

  <div id="result"></div>

  <script>
    document.getElementById('shippingForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const resultBox = document.getElementById('result');
      resultBox.innerHTML = "計算中...";

      let length_cm = parseFloat(document.getElementById('length').value);
      let width_cm = parseFloat(document.getElementById('width').value);
      let height_cm = parseFloat(document.getElementById('height').value);
      let weight_kg = parseFloat(document.getElementById('weight').value);
      let zipcode = document.getElementById('zipcode').value.trim();

      // 換算成英吋 (無條件進位)
      let length_in = Math.ceil(length_cm / 2.54);
      let width_in = Math.ceil(width_cm / 2.54);
      let height_in = Math.ceil(height_cm / 2.54);

      // 計算材積重
      let vol_weight = Math.ceil((length_in * width_in * height_in) / 139);

      // 換算重量 (磅)
      let actual_weight = Math.ceil(weight_kg / 0.454);

      // 取最大值
      let billable_weight = Math.max(vol_weight, actual_weight);

      // 台灣到美國國際運費
      let intl_shipping = billable_weight * 3.99;

      // 服務費
      let service_fee = (billable_weight <= 20) ? 6 : 0;

      try {
        // 呼叫 GAS Web App
        const response = await fetch("https://script.google.com/macros/s/AKfycbw73oepvUacco7K_sqnGDiZVSqn9qtzSDfhOjxFi3bcW6KioJ3gubFXgaL8VsjYab7cnQ/exec" + "?zipcode=" + zipcode + "&weight=" + billable_weight);
        const data = await response.json();

        if (data.error) {
          resultBox.innerHTML = `<p class="error">${data.error}</p>`;
          return;
        }

        let domestic_shipping = parseFloat(data.domestic_fee) || 0;
        let total = intl_shipping + service_fee + domestic_shipping;

        resultBox.innerHTML = `
          <p>計費重量: ${billable_weight} 磅</p>
          <p>國際運費: $${intl_shipping.toFixed(2)}</p>
          <p>服務費: $${service_fee.toFixed(2)}</p>
          <p>美國國內運費: $${domestic_shipping.toFixed(2)}</p>
          <hr>
          <p><strong>總運費: $${total.toFixed(2)}</strong></p>
        `;
      } catch (err) {
        resultBox.innerHTML = `<p class="error">伺服器錯誤，請稍後再試。</p>`;
      }
    });
  </script>
</body>
</html>
