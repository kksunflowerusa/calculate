<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>運費計算機</title>
<style>
body { font-family: Arial, Helvetica, sans-serif; max-width:760px; margin:30px auto; padding:10px; }
label { display:block; margin-top:10px; }
input[type="number"], input[type="text"] { width:160px; padding:6px; }
button { margin-top:12px; padding:8px 14px; }
.result { margin-top:16px; padding:12px; border:1px solid #ddd; background:#fafafa; }
.error { color: #b00; }
</style>
</head>
<body>
<h2>B3運費計算機</h2>
<form id="calcForm">
  <label>長（公分） <input id="length" type="number" step="0.01" required /></label>
  <label>寬（公分） <input id="width" type="number" step="0.01" required /></label>
  <label>高（公分） <input id="height" type="number" step="0.01" required /></label>
  <label>重量（公斤） <input id="weight" type="number" step="0.01" required /></label>
  <label>收件 Zip code（美國） <input id="zip" type="text" required /></label>

  <button type="submit">計算運費</button>
</form>

<div id="msg" class="error"></div>
<div id="out" class="result" style="display:none;"></div>

<script>
const GAS_URL = 'https://script.google.com/macros/s/AKfycbxc86FR5TGGRvrKOkHct0q2QuAYWf05cneysQdHEmwX6bboJn2DSfHK1JX5dQQWR2sW1g/exec';

document.getElementById('calcForm').addEventListener('submit', async function(e){
  e.preventDefault();
  document.getElementById('msg').textContent = '';
  document.getElementById('out').style.display = 'none';

  const length = parseFloat(document.getElementById('length').value);
  const width  = parseFloat(document.getElementById('width').value);
  const height = parseFloat(document.getElementById('height').value);
  const weight = parseFloat(document.getElementById('weight').value);
  const zip    = document.getElementById('zip').value.trim();

  if (!length || !width || !height || !weight || !zip) {
    document.getElementById('msg').textContent = '請輸入所有欄位';
    return;
  }

  // 前端先計算材積重與實際重量（磅）
  function cmToInchesCeil(cm){ return Math.ceil(cm / 2.54); }
  const L_in = cmToInchesCeil(length);
  const W_in = cmToInchesCeil(width);
  const H_in = cmToInchesCeil(height);
  const volumetric_raw = (L_in * W_in * H_in) / 139;
  const volumetric_w = Math.ceil(volumetric_raw);
  const actual_w = Math.ceil(weight / 0.454);
  const billingWeight = Math.max(volumetric_w, actual_w);

  // 超過 100 磅 → 提示聯繫客服
  if (billingWeight > 100) {
    document.getElementById('out').innerHTML = '<strong>計費重量超過 100 磅</strong>，請聯繫客服報價';
    document.getElementById('out').style.display = 'block';
    return;
  }

  // 呼叫 Apps Script 後端
  const url = GAS_URL +
    '?length_cm=' + encodeURIComponent(length) +
    '&width_cm='  + encodeURIComponent(width) +
    '&height_cm=' + encodeURIComponent(height) +
    '&weight_kg=' + encodeURIComponent(weight) +
    '&zip='       + encodeURIComponent(zip);

  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.error) {
      document.getElementById('msg').textContent = '錯誤：' + (data.message || data.error);
      console.error(data);
      return;
    }

    const o = data;
    const r = o.rates;
    const comp = o.computed;

    let html = `
      <strong>分區：</strong> ${o.zone} <br/>
      <strong>計費重量（磅）：</strong> ${comp.billingWeight}（材積：${comp.volumetric_w} / 實重：${comp.actual_w}）<br/>
      <strong>國際運費：</strong> $${r.internationalRate.toFixed(2)} <br/>
      <strong>服務費：</strong> $${r.serviceFee.toFixed(2)} <br/>
      <strong>美國國內運費：</strong> $${r.domesticRate.toFixed(2)} <br/>
      <hr/>
      <strong>總計：</strong> <span style="font-size:1.2em">$${r.total.toFixed(2)}</span>
    `;

    if (r.cappedTo100) {
      html += '<div style="color:orange"><strong>注意：</strong> 使用上限 100 磅計算</div>';
    }

    document.getElementById('out').innerHTML = html;
    document.getElementById('out').style.display = 'block';

  } catch(err) {
    document.getElementById('msg').textContent = '發生錯誤（網路或後端）';
    console.error(err);
  }
});
</script>
</body>
</html>
